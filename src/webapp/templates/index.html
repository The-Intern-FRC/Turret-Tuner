<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turret-Tuner Dashboard</title>

  <!-- Bootstrap + Chart.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">‚öôÔ∏è Turret-Tuner Dashboard</a>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row justify-content-center g-4">

      <!-- Choice Card -->
      <div class="col-lg-8">
        <div class="card p-4 text-center">
          <h2>üìä Start Analysis</h2>
          <p>Choose an option below to begin your Bayesian analysis:</p>
          <button id="use-test" class="btn btn-primary m-2 w-50">Use Test Logs</button>
          <button id="upload-own" class="btn btn-primary m-2 w-50">Upload Your Own</button>
        </div>
      </div>

      <!-- Upload Section (hidden initially) -->
      <div class="col-lg-8" id="upload-section" style="display:none;">
        <div class="card p-4">
          <h4>üìÅ Upload Your Logs</h4>
          <form id="upload-form" enctype="multipart/form-data">
            <input class="form-control mb-3" type="file" id="file-input" name="file" accept=".csv,.json" required>
            <button type="submit" class="btn btn-primary w-100">Analyze File</button>
          </form>
          <div id="upload-loading" class="loading-bar mt-2" style="display:none;">
            <div class="loading-fill"></div>
          </div>
          <div id="upload-status" class="mt-2"></div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="col-lg-8" id="chart-section" style="display:none;">
        <div class="card p-4">
          <h4>üìà Analysis Results</h4>
          <canvas id="resultsChart"></canvas>
          <button id="generate-pdf" class="btn btn-primary mt-3">Generate PDF Report</button>
          <div id="pdf-status" class="mt-2"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const useTestBtn = document.getElementById('use-test');
    const uploadOwnBtn = document.getElementById('upload-own');
    const uploadSection = document.getElementById('upload-section');
    const uploadForm = document.getElementById('upload-form');
    const uploadLoading = document.getElementById('upload-loading');
    const uploadStatus = document.getElementById('upload-status');

    const chartSection = document.getElementById('chart-section');
    const ctx = document.getElementById('resultsChart').getContext('2d');
    let resultsChart;

    const pdfButton = document.getElementById('generate-pdf');
    const pdfStatus = document.getElementById('pdf-status');
    const pdfLoading = document.createElement('div');
    pdfLoading.className = 'loading-bar mt-2';
    pdfLoading.innerHTML = '<div class="loading-fill"></div>';

    // Show upload form if "Upload Your Own" clicked
    uploadOwnBtn.addEventListener('click', () => {
      uploadSection.style.display = 'block';
      chartSection.style.display = 'none';
    });

    // Run test logs analysis
    useTestBtn.addEventListener('click', async () => {
      chartSection.style.display = 'none';
      uploadStatus.textContent = '';
      uploadLoading.style.display = 'block';
      uploadLoading.querySelector('.loading-fill').style.animationPlayState = 'running';

      try {
        const res = await fetch('/run_test', { method: 'POST' });
        const resultData = await res.json().catch(() => null);
        const data = resultData || { labels: ["Example"], values: [0] }; // fallback

        uploadLoading.style.display = 'none';
        chartSection.style.display = 'block';
        uploadStatus.textContent = "‚úÖ Test analysis complete.";

        if (resultsChart) resultsChart.destroy();
        resultsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Analysis Output',
              data: data.values,
              backgroundColor: '#00bcd4'
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#e0e0e0' } } },
            scales: {
              x: { ticks: { color: '#e0e0e0' } },
              y: { ticks: { color: '#e0e0e0' } }
            }
          }
        });

      } catch (err) {
        uploadLoading.style.display = 'none';
        uploadStatus.textContent = "‚ùå Error running test analysis.";
      }
    });

    // Handle file upload analysis
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('file-input').files[0];
      if (!file) return;

      uploadLoading.style.display = 'block';
      uploadStatus.textContent = "Analyzing data...";

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const resultData = await res.json().catch(() => null);
        const data = resultData || { labels: ["Example"], values: [0] };

        uploadLoading.style.display = 'none';
        chartSection.style.display = 'block';
        uploadStatus.textContent = "‚úÖ Analysis complete.";

        if (resultsChart) resultsChart.destroy();
        resultsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Analysis Output',
              data: data.values,
              backgroundColor: '#00bcd4'
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#e0e0e0' } } },
            scales: {
              x: { ticks: { color: '#e0e0e0' } },
              y: { ticks: { color: '#e0e0e0' } }
            }
          }
        });

      } catch (err) {
        uploadLoading.style.display = 'none';
        uploadStatus.textContent = "‚ùå Error during analysis.";
      }
    });

    // PDF generation
    pdfButton.addEventListener('click', async () => {
      pdfStatus.textContent = "Generating PDF...";
      chartSection.appendChild(pdfLoading);
      pdfLoading.style.display = 'block';
      try {
        const res = await fetch('/generate_pdf');
        if (!res.ok) throw new Error("PDF generation failed");
        const blob = await res.blob();

        pdfLoading.style.display = 'none';
        pdfStatus.textContent = "‚úÖ PDF generated. Downloading...";
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analysis_report.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        pdfLoading.style.display = 'none';
        pdfStatus.textContent = "‚ùå Error generating PDF.";
      }
    });
  </script>
</body>
</html>
